# lxc-create-tests/tasks/main.yml
---

# notes
#
# templates using systemd fails to boot with ubuntu 14.04 lxc version, append this to config (unsafe), needed for jessie and centos7
# - "lxc.aa_profile = unconfined"
#
# centos 7 systemd-journal eats a cpu, needs:
#
# lxc.kmsg = 0
#
# centos 7 times several minutes to boot under ubuntu 14.04 lxc version
# ubuntu-10 does not boot until /dev/shm symlink to /run/shm is removed

####################################
# Create container                 #
####################################

# helper: shows if container exists and/or status
- name: Copy lxc ansible helper
  copy:
    src: lxc-ansible-helper
    dest: /usr/local/bin
    mode: 0755

- name: Get if container exists
  command: /usr/local/bin/lxc-ansible-helper exists "{{ hostvars[guest]['inventory_hostname'] }}"
  register: container_exists_result
  changed_when: False
  ignore_errors: True

- name: Create lxc hosts if do not exist
  lxc_container:
    name: "{{ hostvars[guest]['inventory_hostname'] }}"
    backing_store: dir
    container_config:
      - "lxc.start.auto = 1"
      - "lxc.network.type = veth"
      - "lxc.network.flags = up"
      - "lxc.network.link = br-realtek0"
      - "lxc.network.name = eth0"
    # - "lxc.network.ipv4 = {{ hostvars[guest]['ansible_ssh_host'] }}"
    # - "lxc.network.ipv4.gateway = 192.168.100.250"
    template: "{{ hostvars[guest].lxc_template }}"
    template_options: "--release {{ hostvars[guest].lxc_release }} --arch {{ hostvars[guest].lxc_arch }} {{ hostvars[guest].lxc_opts|default() }} "
    state: stopped
  register: result
  when: container_exists_result.rc == 1

# - name: Centos 7 workaround
#   replace:
#     dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/config
#     regexp: '^lxc.include = /usr/share/lxc/config/centos.common.conf$'
#     replace: 'lxc.include = /usr/share/lxc/config/fedora.common.conf'
# # ignore_errors: True
#   when: hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-centos']
#   when: hostvars[guest].lxc_release == 7

# - name: Centos 7 workaround 2
#   lineinfile:
#     dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/config
#     state: present
#     line: lxc.kmsg = 0
#     regexp: '^lxc.kmsg '
# # ignore_errors: True
#   when: hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-centos']
#   when: hostvars[guest].lxc_release == 7

# # lxc.kmsg = 0
# 
# - name: lxc_unconfied systemd workaround
#   lineinfile:
#     dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/config
#     state: present
#     line: lxc.aa_profile = unconfined
#   when: hostvars[guest].lxc_unconfined|default(False)

- name: Get if container is started
  command: /usr/local/bin/lxc-ansible-helper state "{{ hostvars[guest]['inventory_hostname'] }}"
  register: result
  changed_when: False

# - name: Ubuntu 10 /dev/shm workaround
#   file:
#     dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/dev/shm
#     state: absent
#   when: (hostvars[guest]['lxc_release'] == 'lucid') and (result.stdout in "stopped")

####################################
# Setup ssh/network/rootpwd        #
####################################
- name: Create /root/.ssh folder
  file:
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/root/.ssh
    state: directory

- name: Copy ssh public key
  copy:
    src: id_rsa.pub
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/root/.ssh/authorized_keys
    mode: 0600

- name: Set eth0 interface (Debian)
  template:
    src: interfaces.j2
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/etc/network/interfaces
    mode: 0644
  when: (hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-debian']) or (hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-ubuntu'])

- name: Set eth0 interface (Centos)
  template:
    src: etc_sysconfig_network-scripts_ifcfg-eth0.j2
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/etc/sysconfig/network-scripts/ifcfg-eth0
    mode: 0644
  when: hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-centos']

- name: Set eth0 interface (Centos)
  template:
    src: etc_sysconfig_network.j2
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/etc/sysconfig/network
    mode: 0644
  when: hostvars[guest]['inventory_hostname'] in groups['lxc-test-guest-centos']

- name: Copy resolv.conf
  copy:
    src: resolv.conf
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/etc
    mode: 0644

- name: root password
  replace:
    dest: /var/lib/lxc/{{ hostvars[guest]['inventory_hostname'] }}/rootfs/etc/shadow
    regexp: '^root:.*:(.*):(.*):(.*):(.*):(.*):(.*):(.*)$'
    replace: 'root:{{ hostvars[guest].lxc_password_hash }}::\2:\3:\4:\5:\6:\7'
  ignore_errors: True

####################################
# Start container                  #
####################################
- name: Get if container is started
  command: /usr/local/bin/lxc-ansible-helper state "{{ hostvars[guest]['inventory_hostname'] }}"
  register: result
  changed_when: False

- name: Start container
  lxc_container:
    name: "{{ hostvars[guest]['inventory_hostname'] }}"
    state: started
  when: result.stdout in "stopped"
